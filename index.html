<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Shawoop</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
		#canv {
			margin-left: auto;
			margin-right: auto;
			width: 720px;
		}
    </style>
</head>
<body>
<div id="canv"></div>
<script type="text/javascript">

var SCREEN_WIDTH = 720;
var SCREEN_HEIGHT = 1280;

var menu = function() {};
// Default play state
var play = function() {};
var gameOver = function() {};

var game = new Phaser.Game(SCREEN_WIDTH, SCREEN_HEIGHT, Phaser.AUTO, 'canv', menu, false, false);

var SCALE_FACTOR = 16;
var BASE_MAN_SPEED = 1;
var MAN_SPEED = BASE_MAN_SPEED;
var MAN_SPEED_INC = 0.2;
var BASE_HELI_SPEED = 0.8
var HELI_SPEED = BASE_HELI_SPEED;
var MAN_WALL;
var MAN_PROB = 30;
var HELI_PROB = 120;
var MAN_DAMAGE = .01;
var HELI_DAMAGE = .05;
var HELI_THRESH = 10;
var MAX_HEALTH = 100;
var HEALTH = MAX_HEALTH;
var LAZER_FX;
var EXPLOSION_FX;
var THEME;
var SCORE_TEXT;

var MEN;
var HELIS;
var MAN_COUNT = 0;
var HELI_COUNT = 0;
var SCORE = 0;
var LEVELED_UP = true;

menu.prototype = {
	preload: function() {
		this.state.add("Play", play);
		this.load.image('title', 'assets/title.png');
		this.load.spritesheet('play', 'assets/play.png', 32, 16, 2);
	},
	create: function() {
		this.title = this.add.sprite(0, 0, 'title');
		this.title.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);

		this.playButton = this.add.sprite(7*SCALE_FACTOR, 40*SCALE_FACTOR, 'play');
		this.playButton.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);
		this.playButton.inputEnabled = true;
		this.playButton.animations.add('loop');
		this.playButton.animations.play('loop', 2, true, false);
		this.playButton.events.onInputUp.add(function() {
			this.state.start("Play");
		}, this) // Context
	}
}

play.prototype = {
	preload: function() {
		this.state.add('GameOver', gameOver);
		this.load.spritesheet('background', 'assets/bg.png', 45, 80, 22);
		this.load.spritesheet('monster', 'assets/monster.png', 14, 28, 8);
		this.load.spritesheet('man', 'assets/man.png', 8, 8, 2);
		this.load.spritesheet('explosion', 'assets/explosion.png', 16, 16, 10);
		this.load.spritesheet('emitter', 'assets/emitter.png', 16, 16, 10);
		this.load.spritesheet('heli', 'assets/heli.png', 16, 8, 8);
		this.load.image('health', 'assets/health.png');
		this.load.audio('theme', 'assets/audio/theme.wav');
		this.load.audio('lazer_sound', 'assets/audio/lazer.wav');
		this.load.audio('explosion_sound', 'assets/audio/explosion.wav');
		this.load.bitmapFont('font', 'assets/fonts/pixel.png', 'assets/fonts/pixel.fnt');
		this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
		this.scale.minwidth = 360;
		this.scale.minHeight = 640;
		this.scale.maxWidth = 720;
		this.scale.maxHeight = 1280;
		this.scale.refresh();
	},
	create: function() {
		// this.state.start("GameOver");
		var bg = this.add.sprite(0,0, 'background');
		bg.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);
		bg.animations.add('loop');
		bg.animations.play('loop', 6, true, false);

		var monster = this.add.sprite(15*SCALE_FACTOR, 15*SCALE_FACTOR, 'monster');
		monster.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);
		monster.animations.add('loop');
		monster.animations.play('loop', 12, true, false);
		MAN_WALL = monster.y + monster.height - (8 * SCALE_FACTOR);

		THEME =  this.add.audio('theme');
		THEME.play('', 0, 0.25, true);
		LAZER_FX =  this.add.audio('lazer_sound');
		EXPLOSION_FX =  this.add.audio('explosion_sound');

		MEN = this.add.group();
		HELIS = this.add.group();

		HEALTH_BAR = this.add.sprite(0, SCREEN_HEIGHT, 'health');
		HEALTH_BAR.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);
		HEALTH_BAR.anchor.setTo(0, 1);

		this.input.onDown.add(this.makeLazer, this);
		this.input.onDown.add(this.makeExplosion, this);
		this.input.onDown.add(this.makeLazerEmitter, this);
	},
	update: function() {
		MEN.forEachExists(function(m){
			if (m.y > MAN_WALL) {
				m.y -= MAN_SPEED;
			} else {
				HEALTH -= MAN_DAMAGE;
			}
			if (m.x < SCREEN_WIDTH * 0.35) {
				m.x += 0.5 * MAN_SPEED;
			}
			if (m.x > SCREEN_WIDTH * 0.45) {
				m.x -= 0.5 * MAN_SPEED;
			}
		}, this);
		HELIS.forEachExists(function(m){
			if (m.x > - 8*SCALE_FACTOR) {
				m.x -= HELI_SPEED;
			} else {
				m.destroy();
			}
			if (m.x > 15*SCALE_FACTOR && m.x < 25*SCALE_FACTOR) {
				HEALTH -= HELI_DAMAGE;
			}
		}, this);
		this.randomMan();
		if (SCORE >= HELI_THRESH) {
			this.randomHeli();
		}
		if (SCORE % 10 == 0 && !LEVELED_UP) {
			LEVELED_UP = true;
			MAN_SPEED += MAN_SPEED_INC;
		}
		this.updateHealthBar();
	},
	makeLazer: function(pointer) {
		var lazer = game.add.graphics();

		lazer.lineStyle(SCALE_FACTOR, 0xFF0000, 1);
		lazer.moveTo(22*SCALE_FACTOR, 22*SCALE_FACTOR);
		lazer.lineTo(pointer.x - SCALE_FACTOR/(Math.sqrt(2)), pointer.y - SCALE_FACTOR);

		lazer.lineStyle(SCALE_FACTOR, 0xFF0000, 1);
		lazer.moveTo(23*SCALE_FACTOR, 22*SCALE_FACTOR);
		lazer.lineTo(pointer.x, pointer.y);

		lazer.lineStyle(SCALE_FACTOR, 0xFF0000, 1);
		lazer.moveTo(24*SCALE_FACTOR, 22*SCALE_FACTOR);
		lazer.lineTo(pointer.x + SCALE_FACTOR/(Math.sqrt(2)), pointer.y + SCALE_FACTOR);

		lazer.endFill();
		this.time.events.add(200, lazer.destroy, lazer);
	},
	makeExplosion: function(pointer) {
		var ex = this.add.sprite(pointer.x - 8*SCALE_FACTOR, pointer.y - 8*SCALE_FACTOR, 'explosion');
		ex.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);
		ex.animations.add('one');
		ex.animations.play('one', 24, false, true);
	},
	makeLazerEmitter: function(pointer) {
		var ex = this.add.sprite(14*SCALE_FACTOR, 13*SCALE_FACTOR, 'emitter');
		ex.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);
		ex.animations.add('one');
		ex.animations.play('one', 24, false, true);
		LAZER_FX.play('', 0, 0.5, false, true);
	},
	createMan: function(x, y, group) {
		var man = this.add.sprite(x, y, 'man');
		man.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);
		man.animations.add('loop');
		man.animations.play('loop', 4, true, false);
		man.inputEnabled = true;
		man.events.onInputDown.add(function() {
			SCORE++;
			LEVELED_UP = false;
			man.destroy();
		}, this) // Context
		group.add(man);
		MAN_COUNT++;
	},
	createHeli: function(x, y, group) {
		var heli = this.add.sprite(x, y, 'heli');
		heli.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);
		heli.animations.add('loop');
		heli.animations.play('loop', 12, true, false);
		heli.inputEnabled = true;
		heli.events.onInputDown.add(function() {
			SCORE++;
			heli.destroy();
			EXPLOSION_FX.play('', 0, 0.5, false, true);
		}, this) // Context
		group.add(heli);
		HELI_COUNT++;
	},
	randomMan: function() {
		var r = Math.floor(Math.random() * MAN_PROB);
		if (r === 1) {
			var x = Math.floor(Math.random() * SCREEN_WIDTH);
			var y = SCREEN_HEIGHT + 100;
			this.createMan(x, y, MEN);
		}
	},
	randomHeli: function() {
		var r = Math.floor(Math.random() * HELI_PROB);
		if (r === 1) {
			var x = SCREEN_WIDTH + 16*SCALE_FACTOR;
			var y = 8*SCALE_FACTOR + Math.floor(Math.random() * 16*SCALE_FACTOR);
			this.createHeli(x, y, HELIS);
		}
	},
	updateHealthBar: function() {
		// HEALTH_BAR.crop(new Phaser.Rectangle(0, 0, SCALE_FACTOR, SCREEN_HEIGHT * (HEALTH / 100)));
		// HEALTH_BAR.updateCrop();
		HEALTH_BAR.scale.setTo(SCALE_FACTOR, SCALE_FACTOR * (HEALTH/MAX_HEALTH));
		if (HEALTH <= 0) {
			THEME.stop();
			this.state.start("GameOver");
		}
	}
}

gameOver.prototype = {
	preload: function() {
		this.load.image('over', 'assets/over.png');
	},
	create: function() {
		this.title = this.add.sprite(0, 0, 'over');
		this.title.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);

		SCORE_TEXT = this.add.bitmapText(SCREEN_WIDTH / 2, 10*SCALE_FACTOR, 'font', '', 8);
		SCORE_TEXT.text = SCORE;
		SCORE_TEXT.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);
		SCORE_TEXT.anchor.setTo(0.5, 0.5);

		this.playButton = this.add.sprite(7*SCALE_FACTOR, 60*SCALE_FACTOR, 'play');
		this.playButton.scale.setTo(SCALE_FACTOR, SCALE_FACTOR);
		this.playButton.inputEnabled = true;
		this.playButton.animations.add('loop');
		this.playButton.animations.play('loop', 2, true, false);
		this.playButton.events.onInputUp.add(function() {
			MAN_SPEED = BASE_MAN_SPEED;
			HELI_SPEED = BASE_HELI_SPEED;
			MAN_COUNT = 0;
			HELI_COUNT = 0;
			SCORE = 0;
			HEALTH = MAX_HEALTH;
			this.state.start("Play");
		}, this) // Context
	},
	update: function() {

	}
}

</script>

</body>
</html>
